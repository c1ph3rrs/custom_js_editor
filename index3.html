<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyMCE Editor with Variables</title>
    <script src="https://cdn.tiny.cloud/1/jfdujg0vceh6n8s78zuyo4j5js3iw3d8mmwgjo53o9yt8p9d/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <header>
        <h1>Design Your Layout with Variables</h1>
    </header>
    <main>
        <textarea id="editor"></textarea>
        <button onclick="saveContent()">Save Content</button>
    </main>
    <footer>
        <p>&copy; 2024 Awesome Corp</p>
    </footer>
    <script>

        const customObjData = {
            "tenant": {
                "tenant_no": "2024/TN43",
                "trn": "",
                "customer_name": {
                    "text_en": "Roland Holland"
                },
                "mobile_number": "+971 555222940",
                "phone_number": " ",
                "fax_number": "",
                "email_address": "",
                "po_box": "",
                "area": "",
                "city": "",
                "nationality": {
                    "text_en": "Belgium",
                    "text_ar": "Belgium"
                },
                "remarks": ""
            },
            "property": {
                "property_no": "2024/PR38",
                "property_name": "Dutch Tower",
                "plot_no": "",
                "property_type": {
                    "u_id": "B52303",
                    "value": "Building"
                },
                "area": "",
                "city": "Sharjah",
                "property_price": 0,
                "property_description": "",
                "no_of_floors": 4
            },
            "contract": {
                "purchase_invoice_no": "",
                "contract_status": {
                    "text_en": "active",
                    "text_ar": "active"
                },
                "contract_type": {
                    "text_en": "Residential",
                    "text_ar": "سكني"
                },
                "contract_no": "43265",
                "iq_invoice_no": "INV/2024/123",
                "unit_no": "101",
                "unit_type": "3 BHK",
                "furnished_type": {
                    "text_en": "Unfurnished",
                    "text_ar": "غير مفروش"
                },
                "contract_start_date": {
                    "text_en": "01/12/2024",
                    "text_ar": "٠١/١٢/٢٠٢٤"
                },
                "contract_end_date": {
                    "text_en": "30/11/2025",
                    "text_ar": "٣٠/١١/٢٠٢٥"
                },
                "gross_amount": {
                    "amount_in_numbers": {
                        "text_en": "58,000.00",
                        "text_ar": "٥٨,٠٠٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Fifty Eight Thousand Only",
                        "text_ar": "خمسون وثمانية ألف درهم"
                    }
                },
                "total_discount_amount": {
                    "amount_in_numbers": {
                        "text_en": "2,000.00",
                        "text_ar": "٢,٠٠٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Two Thousand Only",
                        "text_ar": "اثنان ألف درهم"
                    }
                },
                "vat": {
                    "vat_paid_on": {
                        "text_en": "Invalid date",
                        "text_ar": "Invalid date"
                    },
                    "vat_item_title": "5% VAT - (Exclusive)",
                    "vat_per": {
                        "text_en": 5,
                        "text_ar": "٥.٠٠"
                    },
                    "vat_amount": {
                        "amount_in_numbers": {
                            "text_en": "2,900.00",
                            "text_ar": "٢,٩٠٠.٠٠"
                        },
                        "amount_in_words": {
                            "text_en": "Two Thousand Nine Hundred Only",
                            "text_ar": "اثنان ألف تسعة مئة درهم"
                        },
                        "is_vat_paid": {
                            "text_en": "Yes",
                            "text_ar": "نعم"
                        }
                    },
                    "is_vat_paid": {
                        "text_en": "Yes",
                        "text_ar": "نعم"
                    }
                },
                "rental_amount": {
                    "amount_in_numbers": {
                        "text_en": "60,000.00",
                        "text_ar": "٦٠٠٠٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Sixty Thousand Only",
                        "text_ar": "ستون ألف درهم"
                    }
                },
                "net_amount": {
                    "amount_in_numbers": {
                        "text_en": "60,900.00",
                        "text_ar": "٦٠,٩٠٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Sixty Thousand Nine Hundred Only",
                        "text_ar": "ستون ألف تسعة مئة درهم"
                    }
                },
                "total_cheques": {
                    "text_en": 3,
                    "text_ar": "٣"
                },
                "total_paid_cheques": {
                    "text_en": 1,
                    "text_ar": "١"
                },
                "total_paid_amount": {
                    "amount_in_numbers": {
                        "text_en": "21,000.00",
                        "text_ar": "٢١,٠٠٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Twenty One Thousand Only",
                        "text_ar": "عشرون وواحد ألف درهم"
                    }
                },
                "total_partly_paid_cheques": {
                    "text_en": 0,
                    "text_ar": "٠"
                },
                "total_partly_paid_amount": {
                    "amount_in_numbers": {
                        "text_en": "0.00",
                        "text_ar": "٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                },
                "total_due_cheques": {
                    "text_en": 0,
                    "text_ar": "٠"
                },
                "total_due_amount": {
                    "amount_in_numbers": {
                        "text_en": "0.00",
                        "text_ar": "٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                },
                "early_close_charge": {
                    "amount_in_numbers": {
                        "text_en": "0.00",
                        "text_ar": "٠.٠٠"
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                },
                "security_deposit": {
                    "received": {
                        "payment_method": {
                            "text_en": "",
                            "text_ar": ""
                        },
                        "cheque_ref_no": "",
                        "amount": {
                            "amount_in_numbers": {
                                "text_en": "",
                                "text_ar": ""
                            },
                            "amount_in_words": {
                                "text_en": "Zero",
                                "text_ar": "صفر"
                            }
                        }
                    },
                    "store_deposit": {
                        "payment_method": {
                            "text_en": "",
                            "text_ar": ""
                        },
                        "cheque_ref_no": "",
                        "amount": {
                            "amount_in_numbers": {
                                "text_en": "",
                                "text_ar": ""
                            },
                            "amount_in_words": {
                                "text_en": "Zero",
                                "text_ar": "صفر"
                            }
                        },
                        "date": {
                            "text_en": "",
                            "text_ar": ""
                        },
                        "remarks": ""
                    },
                    "refund": {
                        "payment_method": {
                            "text_en": "",
                            "text_ar": ""
                        },
                        "cheque_ref_no": "",
                        "amount": {
                            "amount_in_numbers": {
                                "text_en": "",
                                "text_ar": ""
                            },
                            "amount_in_words": {
                                "text_en": "Zero",
                                "text_ar": "صفر"
                            }
                        },
                        "date": {
                            "text_en": "",
                            "text_ar": ""
                        },
                        "remarks": ""
                    }
                },
                "remarks": null,
                "premises_condition": {
                    "text_en": "",
                    "text_ar": ""
                },
                "payment_condition": {
                    "text_en": "",
                    "text_ar": ""
                }
            },
            "otherCharges": {
                "sub_total": {
                    "amount_in_numbers": {
                        "text_en": "",
                        "text_ar": ""
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                },
                "vat": {
                    "text_en": "",
                    "text_ar": ""
                },
                "vat_title": "",
                "vat_amount": {
                    "amount_in_numbers": {
                        "text_en": "",
                        "text_ar": ""
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                },
                "total_amount": {
                    "amount_in_numbers": {
                        "text_en": "",
                        "text_ar": ""
                    },
                    "amount_in_words": {
                        "text_en": "Zero",
                        "text_ar": "صفر"
                    }
                }
            }
        };


        const customMenuOptions = {
            tenant: {
                tenant_no: "Tenant No",
                trn: "TRN",
                customer_name: {
                    text_en: "Tenant Name (English)",
                    text_ar: "Tenant Name (Arabic)"
                },
                mobile_number: "Mobile Number",
                phone_number: "Phone Number",
                fax_number: "Fax. Number",
                email_address: "Email Address",
                po_box: "P.O. Box",
                area: "Area",
                city: "City",
                nationality: {
                    text_en: "Nationality",
                    //text_ar: "Nationality (Arabic)",
                },
                remarks: "Remarks",
            }, 
            property: {
                property_no: "Property ID",
                property_name: "Property Name",
                plot_no: "Plot Number",
                property_type: "Property Type",
                area: "Area",
                city: "City",
                property_price: "Property Price",
                property_description: "Property Description",
                no_of_floors: "Number of Floors",
                unit_type: "Unit Type"
            },
            contract: {
                purchase_invoice_no: "Purchase Invoice",
                contract_status: {
                    text_en: "Contract Status in English",
                    text_ar: "Contract Status in Arabic",
                },
                contract_type: {
                    text_en: "Contract Type in English",
                    text_ar: "Contract Type in Arabic",
                },
                contract_no: "Contract Number",
                iq_invoice_no: "iQ Invoice Number",
                flat_no: "Unit Number", 
                furnished_type:{
                    text_en: "Furnished Type in English",
                    text_ar: "Furnished Type in Arabic",
                },
                rent_from: {
                    text_en: "Contract Starts From in English, dd/mm/yyyy",
                    text_ar: "Contract Starts From in Arabic, dd/mm/yyyy",
                },
                rent_to: {
                    text_en: "Contract Ends On in English, dd/mm/yyyy",
                    text_ar: "Contract Ends On in Arabic, dd/mm/yyyy",
                },
                vat: {
                    payment_date_en: "VAT Payment Date in English, dd/mm/yyyy",
                    payment_date_ar: "VAT Payment Date in Arabic, dd/mm/yyyy",
                    vat_item_title: "VAT Title",
                    vat_per: "VAT Percentage",
                    vat_amount: 'VAT Amount',
                    is_vat_paid: 'VAT Paid Yes / No',
                }, 
                gross_amount: "Gross Amount",
                total_discount_amount: "Total Discount Amount",
                rental_amount: 'Rental Amount',
                net_amount: 'Net Amount',
                net_amount_in_words: {
                    text_en: "Net Amount in English, in words",
                    text_ar: "Net Amount in Arabic, in words",
                },
                total_cheques: 'Total Installments',
                total_paid_cheques: 'Total Paid Installments',
                total_paid_amount: 'Total Paid Amount',
                total_partly_paid_cheques: 'Total Partly Paid Installments',
                total_partly_paid_amount: 'Total Partly Paid Amount',
                total_due_cheques: 'Total Due Installment',
                total_due_amount: 'Total Due Amount',
                early_close_charge: 'Early Close Charge',
                remarks: 'Remarks',
                premises_condition: {
                    text_en: 'Premises Condition in English',
                    text_ar: 'Premises Condition in Arabic',
                },
                payment_condition: {
                    text_en: 'Payment Condition in English',
                    text_ar: 'Payment Condition in Arabic'
                }   
            },
            otherCharges: {
                sub_total: 'Subtotal',
                vat_title: 'VAT Title',
                vat: 'VAT Percent',
                vat_amount: 'VAT Amount',
                total_amount: 'Total Amount',
            }
        };

        

        tinymce.init({
            selector: 'textarea#editor',
            toolbar_mode: 'floating',
            plugins: [
                "advlist", "anchor", "autolink", "charmap", "code", "fullscreen", 
                "help", "image", "insertdatetime", "link", "lists", "media", 
                "preview", "searchreplace", "table", "visualblocks", "accordion"
            ],
            toolbar: 'undo redo styles bold italic alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | code | hr | vertical-line ltr rtl',
            menubar: 'file edit view insert format tools variable',
            menu: {
                variable: { title: 'Variables', items: 'date customer landlord property room_type contract premises_condition payments_condition other_charges' }
            },
            image_title: true,
            automatic_uploads: true,
            file_picker_types: 'image',
            file_picker_callback: (cb, value, meta) => {
                const url = prompt('Enter the image URL:');
                if (url) {
                    cb(url, { title: 'Image from URL' });
                }
            },
            setup: (editor) => {

                editor.ui.registry.addButton('vertical-line', {
                    text: 'Vertical Line',
                    onAction: () => {
                        editor.insertContent('<div style="display: inline-block; width: 1px; height: 100px; background-color: #000;"></div>');
                    }
                });

                const replacePlaceholdersWithDisplayText = (template, data) => {
                    return template.replace(/\{\{(.*?)\}\}/g, (match, path) => {
                        const keys = path.split('.');
                        let value = data;
                        for (const key of keys) {
                            value = value[key];
                            if (value === undefined) return match; 
                        }
                        return keys[keys.length - 1].split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    });
                };

                const replaceDisplayTextWithPlaceholders = (content, data) => {
                    const flattenObject = (obj, prefix = '') => {
                        if (obj === null || obj === undefined) {
                            return {}; 
                        }

                        return Object.keys(obj).reduce((acc, key) => {
                            const fullKey = prefix ? `${prefix}.${key}` : key;
                            const value = obj[key];

                            if (typeof value === 'object' && value !== null) {
                                Object.assign(acc, flattenObject(value, fullKey));
                            } else {
                                acc[fullKey] = value;
                            }

                            return acc;
                        }, {});
                    };

                    const flatData = flattenObject(data);

                    console.log('Flattened Data:', flatData);
                
                    Object.keys(flatData).forEach(key => {
                        const placeholder = `{{${key}}}`;
                        const displayText = key.split('.').pop().split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                        const regex = new RegExp(`\\b${displayText}\\b`, 'g');
                        content = content.replace(regex, placeholder);
                    });

                    return content;
                };

                const createNestedMenu = () => {
                    Object.keys(customObjData).forEach(key => {
                        const subItems = Object.keys(customObjData[key]).map(subKey => ({
                            type: 'menuitem',
                            text: subKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            onAction: () => {
                                const displayText = subKey.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                                editor.insertContent(`<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1">${displayText}</span>`);
                            },
                        }));

                        editor.ui.registry.addNestedMenuItem(key, {
                            text: key.charAt(0).toUpperCase() + key.slice(1),
                            getSubmenuItems: () => subItems,
                        });
                    });
                };

                createNestedMenu();


                function setEditorContentWithDisplayText(rawTemplate, data) {
                    
                    const flattenObject = (obj, prefix = '') => {
                        return Object.keys(obj).reduce((acc, key) => {
                            const fullKey = prefix ? `${prefix}.${key}` : key;
                            const value = obj[key];

                            if (typeof value === 'object' && value !== null) {
                                Object.assign(acc, flattenObject(value, fullKey));
                            } else {
                                acc[fullKey] = value;
                            }

                            return acc;
                        }, {});
                    };

                    // Flatten the data for easy lookup
                    const flatData = flattenObject(data);

                    // Replace placeholders with display text
                    let renderedContent = rawTemplate.replace(/\{\{(.*?)\}\}/g, (match, path) => {
                        return flatData[path] !== undefined ? flatData[path] : match; // Use display text or keep the placeholder
                    });

                    // Set the editor content
                    const editor = tinymce.activeEditor;
                    if (editor) {
                        editor.setContent(renderedContent);
                        console.log('Editor content set:', renderedContent);
                    } else {
                        console.error('Editor is not initialized.');
                    }
                }



                window.loadContent = (template, data) => {
                    // const renderedContent = replacePlaceholdersWithDisplayText(template, data);
                    setEditorContentWithDisplayText(template, data);
                    // editor.setContent(renderedContent);
                    // console.log('Rendered Content Loaded:', renderedContent);
                };

                window.saveContent = () => {
                    const content = editor.getContent();
                    const rawContent = replaceDisplayTextWithPlaceholders(content, customObjData);
                    console.log('Content Saved with Placeholders:', rawContent);
                };
            }
        });

        const template = '<p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_numbers.text_en}}">{{contract.vat.vat_amount.amount_in_numbers.text_en}}</span>&nbsp; = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_words.text_en}}">{{contract.vat.vat_amount.amount_in_words.text_en}}</span>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_numbers.text_ar}}">{{contract.vat.vat_amount.amount_in_numbers.text_ar}}</span>&nbsp; = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_words.text_ar}}">{{contract.vat.vat_amount.amount_in_words.text_ar}}</span>&nbsp;</p><p>*******************************</p><p>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_numbers.text_en}}">{{contract.gross_amount.amount_in_numbers.text_en}}</span> = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_words.text_en}}">{{contract.gross_amount.amount_in_words.text_en}}</span>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_numbers.text_ar}}">{{contract.gross_amount.amount_in_numbers.text_ar}}</span> = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_words.text_ar}}">{{contract.gross_amount.amount_in_words.text_ar}}</span>&nbsp;</p>';
        setTimeout(() => {
            loadContent(template, customMenuOptions);
        }, 1000);
    </script>
</body>
</html>
