<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyMCE Editor with Variables</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/jfdujg0vceh6n8s78zuyo4j5js3iw3d8mmwgjo53o9yt8p9d/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <script>


        const customMenuOptions = {
            tenant: {
                tenant_no: "Tenant No",
                trn: "TRN",
                customer_name: {
                    text_en: "Tenant Name",
                    //text_ar: "Tenant Name (Arabic)"
                },
                mobile_number: "Mobile Number",
                phone_number: "Phone Number",
                fax_number: "Fax. Number",
                email_address: "Email Address",
                po_box: "P.O. Box",
                area: "Area",
                city: "City",
                nationality: {
                    text_en: "Nationality",
                    //text_ar: "Nationality (Arabic)",
                },
                remarks: "Remarks",
            },
            property: {
                property_no: "Property ID",
                property_name: "Property Name",
                plot_no: "Plot Number",
                property_type: "Property Type",
                area: "Area",
                city: "City",
                property_price: "Property Price",
                property_description: "Property Description",
                no_of_floors: "Number of Floors"
            },
            contract: {
                purchase_invoice_no: "Purchase Invoice",
                contract_status: {
                    text_en: "Contract Status in English",
                    text_ar: "Contract Status in Arabic",
                },
                contract_type: {
                    text_en: "Contract Type in English",
                    text_ar: "Contract Type in Arabic",
                },
                contract_no: "Contract Number",
                iq_invoice_no: "iQ Invoice Number",
                unit_no: "Unit Number",
                unit_type: "Unit Type",
                furnished_type: {
                    text_en: "Furnished Type in English",
                    text_ar: "Furnished Type in Arabic",
                },
                contract_start_date: {
                    text_en: "Contract Starts From in English, dd/mm/yyyy",
                    text_ar: "Contract Starts From in Arabic, dd/mm/yyyy",
                },
                contract_end_date: {
                    text_en: "Contract Ends On in English, dd/mm/yyyy",
                    text_ar: "Contract Ends On in Arabic, dd/mm/yyyy",
                },
                vat: {
                    vat_paid_on: {
                        text_en: "VAT Payment Date in English, dd/mm/yyyy",
                        text_ar: "VAT Payment Date in Arabic, dd/mm/yyyy",
                    },
                    vat_item_title: "VAT Title",
                    vat_per: {
                        text_en: "VAT Percentage in English",
                        text_ar: "VAT Percentage in Arabic",
                    },
                    vat_amount: {
                        amount_in_numbers: {
                            text_en: "VAT Amount in English",
                            text_ar: "VAT Amount in Arabic"
                        },
                        amount_in_words: {
                            text_en: "VAT Amount in English, in words",
                            text_ar: "VAT Amount in Arabic, in words"
                        }
                    },
                    is_vat_paid: {
                        text_en: "VAT Paid? (Yes / No) in English",
                        text_ar: "VAT Paid? (Yes / No) in Arabic",
                    },
                },
                gross_amount: {
                    amount_in_numbers: {
                        text_en: "Gross Amount in English",
                        text_ar: "Gross Amount in Arabic",
                    },
                    amount_in_words: {
                        text_en: "Gross Amount in English, in words",
                        text_ar: "Gross Amount in Arabic, in words",
                    },
                },
                total_discount_amount: {
                    amount_in_numbers: {
                        text_en: "Total Discount Amount in English",
                        text_ar: "Total Discount Amount in Arabic",
                    },
                    amount_in_words: {
                        text_en: "Total Discount Amount in English, in words",
                        text_ar: "Total Discount Amount in Arabic, in words",
                    },
                },
                rental_amount: {
                    amount_in_numbers: {
                        text_en: "Rental Amount in English",
                        text_ar: "Rental Amount in Arabic",
                    },
                    amount_in_words: {
                        text_en: "Rental Amount in English, in words",
                        text_ar: "Rental Amount in Arabic, in words",
                    },
                },
                net_amount: {
                    amount_in_numbers: {
                        text_en: "Net Amount in English",
                        text_ar: "Net Amount in Arabic",
                    },
                    amount_in_words: {
                        text_en: "Net Amount in English, in words",
                        text_ar: "Net Amount in Arabic, in words",
                    }
                },
                total_cheques: {
                    text_en: "Total Installments in English",
                    text_ar: "Total Installments in Arabic",
                },
                total_paid_cheques: {
                    text_en: "Total Paid Installments in English",
                    text_ar: "Total Paid Installments in Arabic",
                },
                early_close_charge: {
                    text_en: "Early Close Charge in English",
                    text_ar: "Early Close Charge in Arabic",
                },
                security_deposit: {
                    received: {
                        payment_method: {
                            text_en: "Payment Method in English",
                            text_ar: "Payment Method in Arabic",
                        },
                        cheque_ref_no: "Cheque / Ref. Number",
                        amount: {   
                            amount_in_numbers: {
                                text_en: "Amount in English",
                                text_ar: "Amount in Arabic",
                            },
                            amount_in_words: {
                                text_en: "Amount in English, in words",
                                text_ar: "Amount in Arabic, in words",
                            }
                        }
                    },
                    store_deposit: {
                        payment_method: {
                            text_en: "Payment Method in English",
                            text_ar: "Payment Method in Arabic",
                        },
                        cheque_ref_no: "Cheque / Ref. Number",
                        amount: {
                            amount_in_numbers: {
                                text_en: "Amount in English",
                                text_ar: "Amount in Arabic",
                            },
                            amount_in_words: {
                                text_en: "Amount in English, in words",
                                text_ar: "Amount in Arabic, in words",
                            }
                        },
                        date: {
                            text_en: "Date in English, dd/mm/yyyy",
                            text_ar: "Date in Arabic, dd/mm/yyyy",
                        },
                        remarks: "Remarks"
                    },
                    refund: {
                        payment_method: {
                            text_en: "Payment Method in English",
                            text_ar: "Payment Method in Arabic",
                        },
                        cheque_ref_no: "Cheque / Ref. Number",
                        amount: {
                            amount_in_numbers: {
                                text_en: "Amount in English",
                                text_ar: "Amount in Arabic",
                            },
                            amount_in_words: {
                                text_en: "Amount in English, in words",
                                text_ar: "Amount in Arabic, in words",
                            }
                        },
                        date: {
                            text_en: "Date in English, dd/mm/yyyy",
                            text_ar: "Date in Arabic, dd/mm/yyyy",
                        },
                        remarks: "Remarks"
                    }
                },
                remarks: "Remarks",
                premises_condition: {
                    text_en: 'Premises Condition in English',
                    text_ar: 'Premises Condition in Arabic',
                },
                payment_condition: {
                    text_en: 'Payment Condition in English',
                    text_ar: 'Payment Condition in Arabic'
                }
            },
            otherCharges: {
                sub_total: {
                    amount_in_numbers: {
                        text_en: 'Subtotal in English',
                        text_ar: 'Subtotal in Arabic',
                    },
                    amount_in_words: {
                        text_en: 'Subtotal in English, in words',
                        text_ar: 'Subtotal in Arabic, in words',
                    }
                },
                vat_title: 'VAT Title',
                otherCharge_vat: {
                    text_en: 'VAT Percent in English',
                    text_ar: 'VAT Percent in Arabic',
                },
                vat_amount: {
                    amount_in_numbers: {    
                        text_en: 'VAT Amount in English',
                        text_ar: 'VAT Amount in Arabic',
                    },
                    amount_in_words: {
                        text_en: 'VAT Amount in English, in words',
                        text_ar: 'VAT Amount in Arabic, in words',
                    }
                },
                total_amount: {
                    amount_in_numbers: {
                        text_en: 'Total Amount in English',
                        text_ar: 'Total Amount in Arabic',
                    },
                    amount_in_words: {
                        text_en: 'Total Amount in English, in words',
                        text_ar: 'Total Amount in Arabic, in words',
                    }
                },
            }
        };


        $(document).ready(function() {
        
            
        
            tinymce.init({
                selector: 'textarea#editor',
                toolbar_mode: 'floating',
                plugins: [
                    "advlist", "anchor", "autolink", "charmap", "code", "fullscreen",
                    "help", "image", "insertdatetime", "link", "lists", "media",
                    "preview", "searchreplace", "table", "visualblocks", "accordion"
                ],
                toolbar: 'undo redo styles bold italic alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | code | hr | vertical-line ltr rtl',
                menubar: 'file edit view insert format tools variable companyLogo',
                menu: {
                    variable: { title: 'Variables', items: 'tenant landlord property room_type contract premisesCondition paymentsCondition otherCharges companyDetails' }
                },
                image_title: true,
                automatic_uploads: true,
                file_picker_types: 'image',
                file_picker_callback: (cb, value, meta) => {
                    const url = prompt('Enter the image URL:');
                    if (url) {
                        cb(url, { title: 'Image from URL' });
                    }
                },
                setup: (editor) => {
        
                    uiEditor = editor;
        
                    editor.ui.registry.addButton('vertical-line', {
                        text: 'Vertical Line',
                        onAction: () => {
                            editor.insertContent('&nbsp;<div style="display: inline-block; width: 1px; height: 100px; background-color: #000;"></div>&nbsp;');
                        }
                    });
        
        
                    
        
                    const createNestedMenu = () => {
                        const createMenuItems = (options, path = '', depth = 0) => {
                            return Object.keys(options).map((key) => {
                                const value = options[key];
                                const currentPath = path ? `${path}.${key}` : key;

                                if (typeof value === "object" && depth < 5) {
                                    let displayText = key.replace(/_/g, ' ').charAt(0).toUpperCase() + key.replace(/_/g, ' ').slice(1).replace(/([A-Z])/g, " $1").trim();
                                    if (currentPath.toLowerCase().includes('vat')) {
                                        displayText = displayText.replace(/\bVat\b/gi, 'VAT');
                                    }
                                    return {
                                        type: "nestedmenuitem",
                                        text: displayText,
                                        getSubmenuItems: () => createMenuItems(value, currentPath, depth + 1),
                                    };
                                } else {
                                    return {
                                        type: "menuitem",
                                        text: value,
                                        onAction: () => {
                                            const placeholder = `{{${currentPath}}}`;
                                            const displayLabel = value; // Use the descriptive label

                                            editor.insertContent(
                                                `&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1" contenteditable="false" data-path="${placeholder}">${displayLabel}</span>&nbsp;`
                                            );
                                        },
                                    };
                                }
                            });
                        };

                        Object.keys(customMenuOptions).forEach((key) => {
                            let displayText = key.replace(/_/g, ' ').charAt(0).toUpperCase() + key.replace(/_/g, ' ').slice(1).replace(/([A-Z])/g, " $1").trim();
                            if (key.toLowerCase().includes('vat')) {
                                displayText = displayText.replace(/\bVat\b/gi, 'VAT');
                            }
                            editor.ui.registry.addNestedMenuItem(key, {
                                text: displayText,
                                getSubmenuItems: () => createMenuItems(customMenuOptions[key], key),
                            });
                        });
                    };


        
                    createNestedMenu();
        
        
                    function setEditorContentWithDisplayText(rawTemplate, data) {
                        const flattenObject = (obj, prefix = '') => {
                            return Object.keys(obj).reduce((acc, key) => {
                                const fullKey = prefix ? `${prefix}.${key}` : key;
                                const value = obj[key];

                                if (typeof value === 'object' && value !== null) {
                                    Object.assign(acc, flattenObject(value, fullKey));
                                } else {
                                    acc[fullKey] = value;
                                }

                                return acc;
                            }, {});
                        };

                        const flatData = flattenObject(data);

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(rawTemplate, 'text/html');

                        doc.querySelectorAll('[data-path]').forEach((el) => {
                            const path = el.getAttribute('data-path').replace(/\{\{|\}\}/g, '');
                            if (flatData[path] !== undefined) {
                                el.textContent = flatData[path];
                            }
                        });

                        const editor = tinymce.activeEditor;
                        if (editor) {
                            editor.setContent(doc.body.innerHTML); // Set the modified HTML as the editor content
                            console.log('Editor content set:', doc.body.innerHTML);
                        } else {
                            console.error('Editor is not initialized.');
                        }
                    }


                    const flattenMenuOptions = (obj, prefix = '') => {
                        return Object.keys(obj).reduce((acc, key) => {
                            const fullKey = prefix ? `${prefix}.${key}` : key;
                            const value = obj[key];

                            if (typeof value === 'object' && value !== null && !value.text_en && !value.text_ar) {
                                Object.assign(acc, flattenMenuOptions(value, fullKey));
                            } else if (typeof value === 'object' && (value.text_en || value.text_ar)) {
                                if (value.text_en) acc[value.text_en] = `${fullKey}.text_en`;
                                if (value.text_ar) acc[value.text_ar] = `${fullKey}.text_ar`;
                            } else if (typeof value === 'string') {
                                acc[value] = fullKey; 
                            }

                            return acc;
                        }, {});
                    };

                    const replaceDisplayTextWithPlaceholders = (content) => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(content, 'text/html');

                        doc.querySelectorAll('span[data-path]').forEach((span) => {
                            const fullPath = span.getAttribute('data-path');
                            span.textContent = fullPath; // Replace the visible label with the full path
                        });

                        return doc.body.innerHTML;
                    };


                    window.saveContent = () => {
                        const content = editor.getContent(); // Get content from TinyMCE editor
                        const rawContent = replaceDisplayTextWithPlaceholders(content, customMenuOptions);
                        console.log('Content Saved with Placeholders:', rawContent);
                    };


                    window.loadContent = (template, data) => {
                        setEditorContentWithDisplayText(template, data); 
                    };
        
                }
            });
                          
            
         
        });

        const template = '<p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_numbers.text_en}}">{{contract.vat.vat_amount.amount_in_numbers.text_en}}</span>&nbsp; = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_words.text_en}}">{{contract.vat.vat_amount.amount_in_words.text_en}}</span>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_numbers.text_ar}}">{{contract.vat.vat_amount.amount_in_numbers.text_ar}}</span>&nbsp; = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.vat.vat_amount.amount_in_words.text_ar}}">{{contract.vat.vat_amount.amount_in_words.text_ar}}</span>&nbsp;</p><p>*******************************</p><p>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_numbers.text_en}}">{{contract.gross_amount.amount_in_numbers.text_en}}</span> = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_words.text_en}}">{{contract.gross_amount.amount_in_words.text_en}}</span>&nbsp;</p><p>&nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_numbers.text_ar}}">{{contract.gross_amount.amount_in_numbers.text_ar}}</span> = &nbsp;<span style="padding: 0px 3px; border-radius: 4px; background-color: #f1f1f1;" contenteditable="false" data-path="{{contract.gross_amount.amount_in_words.text_ar}}">{{contract.gross_amount.amount_in_words.text_ar}}</span>&nbsp;</p>';
        
        setTimeout(() => {
            loadContent(template, customMenuOptions);
        }, 1000);
        
        
        </script>


</head>
<body>
    <header>
        <h1>Design Your Layout with Variables</h1>
    </header>
    <main>
        <textarea id="editor"></textarea>
        <button onclick="saveContent()">Save Content</button>
        <button onclick="viewPreview()">View Preview</button>
    </main>
    <footer>
        <p>&copy; 2024 Awesome Corp</p>
    </footer>



</body>
</html>

<!-- 
{
    "tenant": {
        "tenant_no": "2024/TN1",
        "trn": "",
        "customer_name": {
            "text_en": "Bouihbshje"
        },
        "mobile_number": "+971 583478943",
        "phone_number": " ",
        "fax_number": "",
        "email_address": "itakjs@gmail.com",
        "po_box": "",
        "area": "",
        "city": "",
        "nationality": {
            "text_en": "United States",
            "text_ar": "United States"
        },
        "remarks": ""
    },
    "property": {
        "property_no": "2024/PR1",
        "property_name": "Maryum Tower",
        "plot_no": "INA2BH38299/AJ/AE",
        "property_type": {
            "u_id": "F4EF1D",
            "value": "Tower"
        },
        "area": "Industrial Area",
        "city": "Ajman",
        "property_price": 50000,
        "property_description": "",
        "no_of_floors": 10
    },
    "contract": {
        "purchase_invoice_no": "",
        "contract_status": {
            "text_en": "active",
            "text_ar": "active"
        },
        "contract_type": {
            "text_en": "Residential",
            "text_ar": "سكني"
        },
        "contract_no": "54375635643",
        "iq_invoice_no": "INV/2024/0002",
        "unit_no": "304",
        "furnished_type": {
            "text_en": "Unfurnished",
            "text_ar": "غير مفروش"
        },
        "rent_from": {
            "text_en": "01/01/2025",
            "text_ar": "٠١/٠١/٢٠٢٥"
        },
        "rent_to": {
            "text_en": "31/12/2025",
            "text_ar": "31/12/2025"
        },
        "gross_amount": {
            "text_en": "60,000.00",
            "text_ar": "٦٠,٠٠٠.٠٠"
        },
        "total_discount_amount": {
            "text_en": "0.00",
            "text_ar": "٠.٠٠"
        },
        "vat": {
            "payment_date_en": "Invalid date",
            "payment_date_ar": "Invalid date",
            "vat_item_title": null,
            "vat_per": {
                "text_en": 0,
                "text_ar": "٠.٠٠"
            },
            "vat_amount": {
                "text_en": "0.00",
                "text_ar": "٠.٠٠"
            },
            "is_vat_paid": {
                "text_en": "No",
                "text_ar": "لا"
            }
        },
        "rental_amount": {
            "text_en": "60,000.00",
            "text_ar": "٦٠,٠٠٠.٠٠"
        },
        "net_amount": {
            "text_en": "60,000.00",
            "text_ar": "٦٠,٠٠٠.٠٠"
        },
        "net_amount_in_words": {
            "text_en": "Sixty Thousand Only",
            "text_ar": "ستون ألف درهم"
        },
        "total_cheques": {
            "text_en": 4,
            "text_ar": "٤"
        },
        "total_paid_cheques": {
            "text_en": 0,
            "text_ar": "٠"
        },
        "total_paid_amount": {
            "text_en": "0.00",
            "text_ar": "٠.٠٠"
        },
        "total_partly_paid_cheques": {
            "text_en": 0,
            "text_ar": "٠"
        },
        "total_partly_paid_amount": {
            "text_en": "0.00",
            "text_ar": "٠.٠٠"
        },
        "total_due_cheques": {
            "text_en": 0,
            "text_ar": "٠"
        },
        "total_due_amount": {
            "text_en": "0.00",
            "text_ar": "٠.٠٠"
        },
        "early_close_charge": {
            "text_en": "0.00",
            "text_ar": "٠.٠٠"
        },
        "remarks": null,
        "premises_condition": {
            "text_en": "",
            "text_ar": ""
        },
        "payment_condition": {
            "text_en": "",
            "text_ar": ""
        }
    },
    "otherCharges": {
        "sub_total": {
            "text_en": "",
            "text_ar": ""
        },
        "vat": {
            "text_en": "",
            "text_ar": ""
        },
        "vat_title": "",
        "vat_amount": {
            "text_en": "",
            "text_ar": ""
        },
        "total_amount": {
            "text_en": "",
            "text_ar": ""
        }
    }
} -->